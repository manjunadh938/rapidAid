<!DOCTYPE html>
<html>
<head>
  <title>RapidAid Emergency</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>

<body>

<!-- HEADER -->
<div class="header">
  <img src="logo.jpeg" class="team-logo">
  <div class="logo">RapidAid Emergency</div>
</div>

<!-- LOCK SCREEN -->
<div id="lockScreen" class="lock-screen">
  <div class="lock-content">
    ğŸš¨ EMERGENCY MODE ACTIVE ğŸš¨
    <button id="cancelSOS" class="cancel-btn">Cancel Emergency</button>
  </div>
</div>

<main class="main-container">

  <h3>User Details</h3>
  <input type="text" id="userName" placeholder="Your Name" />
  <input type="tel" id="contactNumber" placeholder="Emergency Phone Number" />

  <button class="sos-button pulse" id="sosBtn">SOS</button>
  <button class="card voice-btn" id="voiceSOS">ğŸ¤ Voice SOS</button>

  <div id="statusBox" class="status-box">ğŸŸ¢ GPS Ready</div>
  <div id="timerBox" class="timer-box"></div>

  <h3>Immediate First Aid</h3>

  <div class="card-row">
    <div class="card" onclick="showHelp('cpr')">â¤ï¸ CPR</div>
    <div class="card" onclick="showHelp('bleeding')">ğŸ©¸ Bleeding</div>
    <div class="card" onclick="showHelp('unconscious')">ğŸ˜µ Unconscious</div>
  </div>

  <div class="help-box" id="helpBox"></div>

</main>

<a id="callBtn" class="call-fab" href="#">ğŸ“</a>
<a class="ambulance-fab" href="tel:108">ğŸš‘</a>
<audio id="siren" src="https://actions.google.com/sounds/v1/alarms/siren_whistle.ogg"></audio>

<script>
window.addEventListener("load", () => {
  const saved = localStorage.getItem("emergencyContact");
  if (saved) document.getElementById("contactNumber").value = saved;
});

/* ================= EMERGENCY MODE ================= */
function activateEmergencyMode() {
  document.getElementById("lockScreen").style.display = "flex";
  document.querySelector(".sos-button").classList.add("active");
  document.getElementById("siren").play();
}

function deactivateEmergencyMode() {
  document.getElementById("lockScreen").style.display = "none";
  document.querySelector(".sos-button").classList.remove("active");
  document.getElementById("siren").pause();
  document.getElementById("siren").currentTime = 0;
  fetch("/resolve", { method: "POST" });
}

document.getElementById("cancelSOS").addEventListener("click", deactivateEmergencyMode);
document.getElementById("sosBtn").addEventListener("click", sendSOS);

/* ================= TIMER ================= */
let seconds = 0;
setInterval(() => {
  if (document.getElementById("lockScreen").style.display === "flex") {
    seconds++;
    document.getElementById("timerBox").innerText =
      "â± Emergency Active: " + seconds + " sec";
  }
}, 1000);

/* ================= SOS FUNCTION ================= */
function sendSOS() {
  const contact = document.getElementById("contactNumber").value;
  const name = document.getElementById("userName").value;

  if (!contact) return alert("Enter emergency contact number");

  localStorage.setItem("emergencyContact", contact);
  document.getElementById("statusBox").innerText = "ğŸ“ Getting Location...";

  navigator.geolocation.getCurrentPosition(position => {
    document.getElementById("statusBox").innerText = "ğŸŸ¢ Location Shared";

    fetch("/sos", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        contact,
        name
      })
    })
    .then(res => res.json())
    .then(data => {
      activateEmergencyMode();

      const mapLink = `https://www.google.com/maps?q=${position.coords.latitude},${position.coords.longitude}`;
      const message = `ğŸš¨ EMERGENCY ALERT ğŸš¨
Name: ${name}
Live Location: ${mapLink}
Nearest Hospital: ${data.hospital}`;

      window.open(`https://wa.me/${contact.replace(/[^0-9]/g,"")}?text=${encodeURIComponent(message)}`, "_blank");
      document.getElementById("callBtn").href = `tel:${contact}`;
    });
  });
}

/* ================= VOICE SOS ================= */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition) {
  const recognition = new SpeechRecognition();
  recognition.continuous = true;

  document.getElementById("voiceSOS").onclick = () => {
    recognition.start();
    alert("Listening for 'help'...");
  };

  recognition.onresult = (event) => {
    if (event.results[event.results.length - 1][0].transcript.toLowerCase().includes("help")) {
      sendSOS();
      recognition.stop();
    }
  };
}

/* ================= FIRST AID ================= */

function showHelp(type) {
  const help = {
    cpr: `
<b>ğŸ«€ CPR (Cardiopulmonary Resuscitation)</b><br><br>

1ï¸âƒ£ Check if the person responds â€” tap and shout loudly.<br>
2ï¸âƒ£ Call emergency services immediately or ask someone nearby.<br>
3ï¸âƒ£ Place the person flat on their back on a firm surface.<br>
4ï¸âƒ£ Kneel beside them and place the heel of one hand in the center of the chest.<br>
5ï¸âƒ£ Place your other hand on top and interlock fingers.<br>
6ï¸âƒ£ Keep arms straight and push hard and fast (100â€“120 compressions per minute).<br>
7ï¸âƒ£ Push at least 2 inches deep and allow the chest to rise fully between pushes.<br>
8ï¸âƒ£ After 30 compressions, if trained, give 2 rescue breaths.<br>
9ï¸âƒ£ Continue CPR until medical help arrives or the person starts breathing.<br>
âš ï¸ Do NOT stop unless exhausted or professionals take over.
`,

    bleeding: `
<b>ğŸ©¸ Severe Bleeding Control</b><br><br>

1ï¸âƒ£ Make the person lie down to prevent fainting.<br>
2ï¸âƒ£ Apply firm, direct pressure on the wound using cloth or bandage.<br>
3ï¸âƒ£ If an object is stuck, DO NOT remove it â€” press around it.<br>
4ï¸âƒ£ Raise the injured area above heart level if possible.<br>
5ï¸âƒ£ If blood soaks through, place another cloth on top â€” donâ€™t remove the first.<br>
6ï¸âƒ£ Keep pressure steady until emergency help arrives.<br>
7ï¸âƒ£ Watch for shock signs: pale skin, fast breathing, dizziness.<br>
âš ï¸ Keep the person warm and calm while waiting for help.
`,

    unconscious: `
<b>ğŸ˜µ Unconscious Person Care</b><br><br>

1ï¸âƒ£ Check breathing and pulse immediately.<br>
2ï¸âƒ£ If not breathing â†’ begin CPR immediately.<br>
3ï¸âƒ£ If breathing, place them in the recovery position (on their side).<br>
4ï¸âƒ£ Tilt the head slightly back to keep airway open.<br>
5ï¸âƒ£ Loosen tight clothing around neck or chest.<br>
6ï¸âƒ£ Do NOT give food, water, or medicine.<br>
7ï¸âƒ£ Monitor breathing until help arrives.<br>
âš ï¸ Call emergency services as soon as possible.
`
  };

  document.getElementById("helpBox").innerHTML = help[type];
}
</script>
</body>
</html>
