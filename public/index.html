<!DOCTYPE html>
<html>
<head>
  <title>RapidAid Emergency</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>

<body>

<!-- HEADER -->
<div class="header">
  <img src="logo.jpeg" class="team-logo">
  <div class="logo">RapidAid Emergency</div>
</div>

<!-- LOCK SCREEN -->
<div id="lockScreen" class="lock-screen">
  <div class="lock-content">
    ğŸš¨ EMERGENCY MODE ACTIVE ğŸš¨
    <button id="cancelSOS" class="cancel-btn">Cancel Emergency</button>
  </div>
</div>

<main class="main-container">

  <h3>User Details</h3>
  <input type="text" id="userName" placeholder="Your Name" />
  <input type="tel" id="contactNumber" placeholder="Emergency Phone Number" />

  <button class="sos-button pulse" id="sosBtn">SOS</button>
  <button class="card voice-btn" id="voiceSOS">ğŸ¤ Voice SOS</button>

  <div id="statusBox" class="status-box">ğŸŸ¢ GPS Ready</div>
  <div id="timerBox" class="timer-box"></div>

  <h3>Immediate First Aid</h3>

  <div class="card-row">
    <div class="card" onclick="showHelp('cpr')">â¤ï¸ CPR</div>
    <div class="card" onclick="showHelp('bleeding')">ğŸ©¸ Bleeding</div>
    <div class="card" onclick="showHelp('unconscious')">ğŸ˜µ Unconscious</div>
  </div>

  <div class="help-box" id="helpBox"></div>

</main>

<!-- CALL BUTTONS -->
<a id="callBtn" class="call-fab" href="#">ğŸ“</a>
<a class="ambulance-fab" href="tel:108">ğŸš‘</a>

<audio id="siren" src="https://actions.google.com/sounds/v1/alarms/siren_whistle.ogg"></audio>

<script>
/* ========== LOAD SAVED USER DETAILS ========== */
window.addEventListener("load", () => {
  const savedContact = localStorage.getItem("emergencyContact");
  const savedName = localStorage.getItem("userName");

  if (savedContact) document.getElementById("contactNumber").value = savedContact;
  if (savedName) document.getElementById("userName").value = savedName;
});

/* ================= EMERGENCY MODE ================= */
function activateEmergencyMode() {
  document.getElementById("lockScreen").style.display = "flex";
  document.querySelector(".sos-button").classList.add("active");
  document.getElementById("siren").play();
}

function deactivateEmergencyMode() {
  document.getElementById("lockScreen").style.display = "none";
  document.querySelector(".sos-button").classList.remove("active");
  document.getElementById("siren").pause();
  document.getElementById("siren").currentTime = 0;
  fetch("/resolve", { method: "POST" });
}

document.getElementById("cancelSOS").addEventListener("click", deactivateEmergencyMode);
document.getElementById("sosBtn").addEventListener("click", sendSOS);

/* ================= TIMER ================= */
let seconds = 0;
setInterval(() => {
  if (document.getElementById("lockScreen").style.display === "flex") {
    seconds++;
    document.getElementById("timerBox").innerText =
      "â± Emergency Active: " + seconds + " sec";
  }
}, 1000);

/* ================= SOS FUNCTION ================= */
function sendSOS() {
  const contact = document.getElementById("contactNumber").value;
  const name = document.getElementById("userName").value;

  if (!contact) return alert("Enter emergency contact number");

  // Save for next time
  localStorage.setItem("emergencyContact", contact);
  localStorage.setItem("userName", name);

  document.getElementById("statusBox").innerText = "ğŸ“ Getting Location...";

  navigator.geolocation.getCurrentPosition(position => {
    document.getElementById("statusBox").innerText = "ğŸŸ¢ Location Shared";

    fetch("/sos", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        contact,
        name
      })
    })
    .then(res => res.json())
    .then(data => {
      activateEmergencyMode();

      const mapLink = `https://www.google.com/maps?q=${position.coords.latitude},${position.coords.longitude}`;
      const message = `ğŸš¨ EMERGENCY ALERT ğŸš¨
Name: ${name}
Live Location: ${mapLink}
Nearest Hospital: ${data.hospital}`;

      window.open(`https://wa.me/${contact.replace(/[^0-9]/g,"")}?text=${encodeURIComponent(message)}`, "_blank");
      document.getElementById("callBtn").href = `tel:${contact}`;
    });
  });
}

/* ================= VOICE SOS ================= */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition) {
  const recognition = new SpeechRecognition();
  recognition.continuous = true;

  document.getElementById("voiceSOS").onclick = () => {
    recognition.start();
    alert("Listening for 'help'...");
  };

  recognition.onresult = (event) => {
    if (event.results[event.results.length - 1][0].transcript.toLowerCase().includes("help")) {
      sendSOS();
      recognition.stop();
    }
  };
}

/* ================= FIRST AID ================= */
function showHelp(type) {
  const help = {
    cpr: `<b>ğŸ«€ CPR (Cardiopulmonary Resuscitation)</b><br><br>
1ï¸âƒ£ Check responsiveness and breathing.<br>
2ï¸âƒ£ Call emergency services immediately.<br>
3ï¸âƒ£ Push hard & fast (100â€“120/min).<br>
4ï¸âƒ£ 30 compressions + 2 breaths if trained.<br>
âš ï¸ Continue until help arrives.`,
    bleeding: `<b>ğŸ©¸ Severe Bleeding</b><br><br>
1ï¸âƒ£ Apply firm pressure on wound.<br>
2ï¸âƒ£ Raise injured area if possible.<br>
3ï¸âƒ£ Do not remove embedded objects.<br>
âš ï¸ Keep pressure until help arrives.`,
    unconscious: `<b>ğŸ˜µ Unconscious Person</b><br><br>
1ï¸âƒ£ Check breathing.<br>
2ï¸âƒ£ If breathing â†’ recovery position.<br>
3ï¸âƒ£ If not â†’ start CPR.<br>
âš ï¸ Do not give food or water.`
  };

  document.getElementById("helpBox").innerHTML = help[type];
}
</script>
</body>
</html>
